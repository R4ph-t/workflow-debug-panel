"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("react/jsx-runtime"),a=require("react"),B=[{id:"trn-mock001",task_id:"root_task",status:"completed",input:"https://example.com",startedAt:new Date(Date.now()-45e3).toISOString(),completedAt:new Date(Date.now()-2e3).toISOString()},{id:"trn-mock002",task_id:"child_task",status:"running",input:"https://example.com/page",startedAt:new Date(Date.now()-5e3).toISOString()}],H=[{time:"12:34:56",message:"Workflow started",type:"success"},{time:"12:34:55",message:"✓ Task completed"}];function K({taskRunId:c,statusUrl:F,streamUrl:U,onComplete:b,onError:m,extractPath:f=x=>{try{return new URL(x).pathname||"/"}catch{return x}},useMock:i=!1,mockTasks:L,mockLogs:P}){const x=L??B,_=P??H,[M,p]=a.useState(i?"running":"idle"),[G,h]=a.useState(i?x:[]),[I,W]=a.useState(i?_:[]),[y,R]=a.useState(0),[$,O]=a.useState(!1),[d,T]=a.useState(!1),k=a.useRef(Date.now()),j=a.useRef(null),g=a.useRef(null),S=a.useRef(new Set),N=a.useRef(!1),w=a.useRef(!1),v=a.useRef(!1),D=!!c||i,A=a.useCallback(e=>c?e.replace("{taskRunId}",c):e,[c]),l=a.useCallback((e,r)=>{const n=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"});W(s=>[{time:n,message:e,type:r},...s].slice(0,15))},[]),C=a.useCallback(async()=>{const e=await fetch(A(F));if(!e.ok)throw new Error("Failed to fetch status");return e.json()},[A,F]),E=a.useCallback(()=>{if(!c||!b||!m)return;l("Using polling fallback");const e=async()=>{if(!v.current)try{const r=await C();if(p(r.status),r.tasks){h(r.tasks);for(const n of r.tasks)n.status==="completed"&&!S.current.has(n.id)&&(S.current.add(n.id),n.input&&l(`✓ ${f(n.input)}`))}r.status==="completed"&&r.results?(v.current=!0,T(!0),N.current=!0,l("Workflow completed","success"),b(r.results)):r.status==="failed"?(v.current=!0,T(!0),N.current=!0,l("Workflow failed","error"),m("Workflow execution failed")):setTimeout(e,2e3)}catch(r){console.error("Polling error:",r),setTimeout(e,2e3)}};e()},[c,l,f,b,m,C]);return a.useEffect(()=>{i&&(p("running"),h(x),W(_),R(0),k.current=Date.now())},[i,x,_]),a.useEffect(()=>{c&&!i&&(p("pending"),h([]),W([]),R(0),O(!1),T(!1),k.current=Date.now(),S.current=new Set,N.current=!1,v.current=!1)},[c,i]),a.useEffect(()=>{if(D)return l("Workflow started"),j.current=setInterval(()=>{R(Math.floor((Date.now()-k.current)/1e3))},1e3),()=>{j.current&&clearInterval(j.current)}},[D,l]),a.useEffect(()=>{d&&j.current&&(clearInterval(j.current),j.current=null)},[d]),a.useEffect(()=>{var r;if(!D||!c||d||i){(r=g.current)==null||r.close();return}const e=new EventSource(A(U));return g.current=e,e.addEventListener("connected",()=>{O(!0),w.current=!0,l("Connected to event stream")}),e.addEventListener("initial",n=>{try{const s=JSON.parse(n.data);p(s.status),s.tasks&&h(s.tasks)}catch(s){console.error("Error parsing initial event:",s)}}),e.addEventListener("taskUpdate",n=>{try{const s=JSON.parse(n.data);h(o=>o.find(u=>u.id===s.id)?o.map(u=>u.id===s.id?{...u,status:s.status,startedAt:s.startedAt||u.startedAt,completedAt:s.completedAt||u.completedAt,input:s.input||u.input}:u):[...o,{id:s.id,status:s.status,task_id:s.task_name,input:s.input,startedAt:s.startedAt,completedAt:s.completedAt}]),s.status==="completed"&&!S.current.has(s.id)&&(S.current.add(s.id),s.input&&l(`✓ ${f(s.input)}`))}catch(s){console.error("Error parsing taskUpdate:",s)}}),e.addEventListener("done",async n=>{N.current=!0,T(!0);try{const s=JSON.parse(n.data);p(s.status);try{const o=await C();o.tasks&&h(o.tasks)}catch{console.warn("Could not fetch final task statuses")}if(s.status==="completed"&&s.results&&b){const o=Array.isArray(s.results)?s.results[0]:s.results;l("Workflow completed","success"),setTimeout(()=>b(o),300)}else s.status==="failed"&&m&&(l("Workflow failed","error"),m("Workflow execution failed"))}catch(s){console.error("Error parsing done event:",s)}e.close()}),e.addEventListener("error",n=>{if(!(N.current||d)){console.error("SSE error event:",n);try{const s=JSON.parse(n.data||"{}");s.error&&l(`Error: ${s.error}`,"error")}catch{w.current||(l("SSE unavailable, using polling"),E())}}}),e.onerror=()=>{N.current||d||(console.warn("SSE connection error"),w.current||(e.close(),E()))},()=>{e.close()}},[D,c,A,U,l,f,b,m,E,d,C,i]),{status:M,tasks:G,logs:I,elapsed:y,connected:$,finished:d,addLog:l}}function q({taskRunId:c,statusUrl:F,streamUrl:U,title:b="Workflow Debug",displayName:m,taskDefinitions:f=[],taskDescriptions:i={},workflowSlug:L,workflowConfigured:P=!0,apiReachable:x=!0,onComplete:_,onError:M,collapsed:p=!1,onToggle:G,useMock:h=!1,mockTasks:I,mockLogs:W}){const y=a.useRef(null),R=a.useRef(Date.now()),$=e=>{try{return new URL(e).pathname||"/"}catch{return e}},{status:O,tasks:d,logs:T,elapsed:k,finished:j}=K({taskRunId:c,statusUrl:F,streamUrl:U,onComplete:_,onError:M,extractPath:$,useMock:h,mockTasks:I,mockLogs:W}),g=!!c||h;a.useEffect(()=>{y.current&&d.length>0&&(y.current.scrollTop=y.current.scrollHeight)},[d]);const S=e=>{const r=Math.floor(e/60),n=e%60;return`${r}:${n.toString().padStart(2,"0")}`},N=e=>{if(!e.startedAt)return null;const r=new Date(e.startedAt).getTime(),s=(e.completedAt?new Date(e.completedAt).getTime():Date.now())-r;return s<1e3?`${s}ms`:`${(s/1e3).toFixed(1)}s`},w=[...d].sort((e,r)=>{const n=e.startedAt?new Date(e.startedAt).getTime():Number.MAX_SAFE_INTEGER,s=r.startedAt?new Date(r.startedAt).getTime():Number.MAX_SAFE_INTEGER;return n-s}),v=(()=>{const e=w.filter(s=>s.startedAt);if(e.length===0)return{start:R.current,end:Date.now(),duration:k*1e3||1};const r=Math.min(...e.map(s=>new Date(s.startedAt??Date.now()).getTime())),n=Math.max(...e.map(s=>s.completedAt?new Date(s.completedAt).getTime():Date.now()));return{start:r,end:n,duration:Math.max(n-r,1)}})(),D=e=>{if(!e.startedAt)return{left:"0%",width:"0%"};const r=new Date(e.startedAt).getTime(),n=e.completedAt?new Date(e.completedAt).getTime():Date.now(),s=(r-v.start)/v.duration*100,o=(n-r)/v.duration*100;return{left:`${Math.max(0,s)}%`,width:`${Math.max(1,Math.min(100-s,o))}%`}},A={};for(const e of f){const r=w.filter(n=>n.task_id===e);A[e]={total:r.length,completed:r.filter(n=>n.status==="completed").length,running:r.filter(n=>n.status==="running").length}}const l=w.filter(e=>e.status==="failed"),E=x?P?g?j?O==="completed"?{text:"Completed",color:"bg-emerald-500"}:{text:"Failed",color:"bg-red-500"}:{text:O.toUpperCase(),color:"bg-emerald-500 animate-pulse"}:{text:"Ready",color:"bg-emerald-500"}:{text:"Not configured",color:"bg-yellow-500"}:{text:"API unreachable",color:"bg-red-500"};return t.jsxs("div",{className:"border border-neutral-700",children:[t.jsxs("button",{type:"button",onClick:G,className:`w-full px-3 py-2 flex justify-between items-center text-xs hover:bg-neutral-900/50 transition-colors ${p?"":"border-b border-neutral-700"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("svg",{className:`w-3 h-3 text-neutral-500 transition-transform ${p?"-rotate-90":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","aria-hidden":"true",strokeWidth:2,children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 9l-7 7-7-7"})}),t.jsx("span",{className:"text-neutral-400 uppercase tracking-wider",children:b})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${E.color}`}),t.jsx("span",{className:"text-neutral-500",children:E.text})]}),g&&t.jsx("span",{className:"font-mono text-neutral-500",children:S(k)})]})]}),!p&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"border-b border-neutral-700 px-3 py-2",children:[t.jsx("div",{className:"text-[10px] text-neutral-600 uppercase tracking-wider mb-1.5",children:"Discovered Tasks"}),x?P?f.length===0?t.jsxs("div",{className:"text-xs text-yellow-400",children:[t.jsxs("p",{className:"mb-1",children:["No tasks found",L?` for "${L}"`:""]}),t.jsx("p",{className:"text-neutral-500 text-[10px]",children:"Deploy the workflow service first."})]}):t.jsx("div",{className:"flex flex-wrap gap-x-4 gap-y-1 text-xs",children:f.map(e=>{const r=A[e];return t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:"font-mono text-neutral-300",children:e}),g&&r&&t.jsxs("span",{className:"text-neutral-600",children:["(",r.total,")",r.total>0&&t.jsxs("span",{className:"ml-1",children:[r.completed>0&&t.jsxs("span",{className:"text-emerald-500",children:["✓",r.completed]}),r.running>0&&t.jsxs("span",{className:"text-neutral-400 ml-1",children:[r.running,"↻"]})]})]}),i[e]&&t.jsx("span",{className:"text-neutral-700 text-[10px]",children:i[e]})]},e)})}):t.jsxs("div",{className:"text-xs text-yellow-400",children:[t.jsx("p",{className:"mb-1",children:"Workflow not configured"}),t.jsx("p",{className:"text-neutral-500 text-[10px]",children:L?"Set WORKFLOW_SLUG env var on your API service.":"Configure the workflow on your backend."})]}):t.jsxs("div",{className:"text-xs text-red-400",children:[t.jsx("p",{className:"mb-1",children:"Cannot reach the API"}),t.jsx("p",{className:"text-neutral-500 text-[10px]",children:"Check that the backend is deployed and API URL is set."})]})]}),g&&l.length>0&&t.jsxs("div",{className:"border-b border-neutral-700 px-3 py-2 bg-red-950/20",children:[t.jsxs("div",{className:"text-[10px] text-red-500 uppercase tracking-wider mb-1.5",children:["Errors (",l.length,")"]}),t.jsx("div",{className:"space-y-1",children:l.slice(0,3).map(e=>t.jsxs("div",{className:"text-xs",children:[t.jsx("span",{className:"text-red-500",children:"⚠"})," ",t.jsx("span",{className:"font-mono text-neutral-400",children:e.task_id}),e.input&&t.jsx("span",{className:"text-neutral-500 ml-2 font-mono",children:$(e.input)})]},e.id))})]}),g&&t.jsxs("div",{ref:y,className:"border-b border-neutral-700 max-h-56 overflow-y-auto",children:[t.jsx("div",{className:"text-[10px] text-neutral-600 uppercase tracking-wider px-3 py-1.5 border-b border-neutral-800",children:"Timeline"}),w.length===0&&t.jsxs("div",{className:"p-3 flex items-center gap-2 text-xs text-neutral-400",children:[t.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"}),t.jsx("span",{children:"Starting workflow..."})]}),w.map(e=>{const r=D(e),n=N(e),s=e.status==="running",o=e.status==="completed",J=e.status==="failed",u=()=>m&&e.task_id===f[0]?m:e.input?$(e.input):e.task_id||e.id||"-";return t.jsxs("div",{className:"flex items-center px-2 py-0 hover:bg-neutral-900/30 text-xs",children:[t.jsx("span",{className:"shrink-0 w-4",children:o?t.jsx("span",{className:"text-emerald-500",children:"✓"}):J?t.jsx("span",{className:"text-red-500",children:"✗"}):s?t.jsx("span",{className:"inline-block w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"}):t.jsx("span",{className:"inline-block w-1.5 h-1.5 border border-neutral-600 rounded-full"})}),t.jsx("span",{className:"shrink-0 w-28 font-mono text-neutral-400 truncate",children:u()}),t.jsx("span",{className:"shrink-0 w-16 font-mono text-neutral-500 text-right mr-3",children:n||(s?"…":"")}),t.jsx("div",{className:"flex-1 self-stretch py-px",children:t.jsx("div",{className:"relative h-full bg-neutral-800/30",children:t.jsx("div",{className:`absolute top-0 h-full ${J?"bg-red-500":o?"bg-neutral-600":s?"bg-emerald-500":"bg-neutral-700"}`,style:{left:r.left,width:r.width}})})})]},e.id)})]}),g&&t.jsxs("div",{className:"px-3 py-2 max-h-20 overflow-y-auto",children:[t.jsx("div",{className:"text-[10px] text-neutral-600 uppercase tracking-wider mb-1",children:"Log"}),t.jsx("div",{className:"space-y-0",children:T.slice(0,5).map(e=>t.jsxs("div",{className:`text-[10px] font-mono flex gap-2 leading-relaxed ${e.type==="success"?"text-emerald-500":e.type==="error"?"text-red-500":"text-neutral-500"}`,children:[t.jsx("span",{className:"text-neutral-700 shrink-0",children:e.time}),t.jsx("span",{className:"truncate",children:e.message})]},`${e.time}-${e.message}`))})]})]})]})}exports.WorkflowDebugPanel=q;exports.useWorkflowStream=K;
